{% extends 'base.html' %}

{% block title %}管理员 - 分配报销(项目)类别{% endblock %}

{% block content %}

<!-- 分配报销项目 -->
<h1>分配报销项目</h1>

<!-- 添加筛选框 -->
<form class="layui-form layui-row layui-col-space16" lay-filter="searchProjectForm">
    <!-- 项目名称 -->
    <div class="layui-col-md3">
        <div class="layui-input-wrap">
            <div class="layui-input-prefix">
                <i class="layui-icon layui-icon-search"></i>
            </div>
            <input type="text" name="project_name" value="" placeholder="输入项目名称" class="layui-input" lay-affix="clear">
        </div>
    </div>

    <!-- 项目来源 -->
    <div class="layui-col-md3">
        <div class="layui-input-wrap">
            <div class="layui-input-prefix">
                <i class="layui-icon layui-icon-search"></i>
            </div>
            <input type="text" name="project_source" value="" placeholder="输入项目来源" class="layui-input"
                lay-affix="clear">
        </div>
    </div>

    <!-- 所属类别 -->
    <div class="layui-col-md3">
        <div class="layui-input-wrap">
            <div class="layui-input-prefix">
                <i class="layui-icon layui-icon-search"></i>
            </div>
            <select name="category_name" lay-search>
                <option value="">请选择所属类别</option>
            </select>
        </div>
    </div>

    <!-- 分配状态筛选 -->
    <div class="layui-col-md3">
        <div class="layui-input-wrap">
            <div class="layui-input-prefix">
                <i class="layui-icon layui-icon-auz"></i>
            </div>
            <select name="assign">
                <option value="-1">不限</option>
                <option value="0">未分配</option>
                <option value="1">已分配</option>
            </select>
        </div>
    </div>

    <!-- 筛选和重置按钮 -->
    <div class="layui-col-md12 layui-btn-container">
        <button class="layui-btn" lay-submit lay-filter="searchProject">筛选</button>
        <button type="reset" class="layui-btn layui-btn-primary" id="resetBtn">清除</button>
    </div>
</form>

<!-- 项目表格 -->
<table class="layui-hide" id="projectTable" lay-filter="projectTable"></table>

<!-- 右侧操作栏 -->
<script type="text/html" id="assignTool">
    <a class="layui-btn layui-btn-xs" lay-event="add">分配报销人员</a>
    <a class="layui-btn layui-btn-xs" lay-event="manage">管理</a>
</script>

<!-- 筛选报销项目脚本 -->
<script>
    layui.use(function () {
        var table = layui.table;
        var form = layui.form;
        var layer = layui.layer;

        // 页面加载时获取类别数据
        fetch('/admin/category/api/search_all')
            .then(response => response.json())
            .then(res => {
                if (res.data) {
                    const select = document.querySelector('select[name="category_name"]');
                    res.data.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.category_name;
                        option.textContent = category.category_name;
                        select.appendChild(option);
                    });
                    form.render('select'); // 刷新选择框渲染
                }
            })
            .catch(err => {
                console.error(err);
                layer.alert('无法获取类别数据，请稍后再试。', { icon: 5 });
            });

        // 初始化表格
        var projectTable = table.render({
            elem: '#projectTable',
            url: '/admin/project/api/search',
            method: 'GET',
            page: true,
            limits: [10, 20, 30, 50],
            limit: 10,
            cols: [[
                { field: 'project_id', title: 'ID', width: 80, sort: true },
                { field: 'project_name', title: '项目名称', minWidth: 150 },
                { field: 'project_source', title: '项目来源', minWidth: 150 },
                { field: 'category_name', title: '所属类别', minWidth: 100 },
                {
                    field: 'total_amount', title: '立项金额 (￥)', minWidth: 100, sort: true,
                    templet: function (d) {
                        return d.total_amount.toLocaleString();
                    }
                },
                {
                    field: 'balance', title: '余额 (￥)', minWidth: 100, sort: true,
                    templet: function (d) {
                        return d.balance.toLocaleString();
                    }
                },
                {
                    field: 'employee_id_list', title: '报销人员', width: 200,
                    templet: function (d) {
                        return d.employee_id_list.length > 0
                            ? d.employee_id_list.join(', ')
                            : '<span style="color: red;">未分配报销人员</span>';
                    }
                },
                { fixed: 'right', title: '操作', templet: '#assignTool' }
            ]],
            toolbar: '#toolbarDemo', // 添加工具条
            title: '报销项目表'
        });

        // 监听筛选表单提交
        form.on('submit(searchProject)', function (data) {
            var field = data.field; // 获取表单字段
            // 重新加载表格，传递筛选参数
            projectTable.reload({
                where: {
                    project_name: field.project_name,
                    project_source: field.project_source,
                    category_name: field.category_name,
                    assign: field.assign
                },
                page: {
                    curr: 1 // 重新从第 1 页开始
                }
            });
            return false; // 阻止表单默认提交
        });

        // 清除按钮点击事件
        document.getElementById('resetBtn').addEventListener('click', function () {
            // 重新加载表格，传递空的筛选参数
            projectTable.reload({
                where: {
                    project_name: '',
                    project_source: '',
                    category_name: '',
                    assign: -1
                },
                page: {
                    curr: 1 // 重新从第1页开始
                }
            });
        });

        // 监听表格中的工具事件
        table.on('tool(projectTable)', function (obj) {
            var data = obj.data; // 当前行数据
            var event = obj.event; // 事件类型

            if (event === 'view') {
                // 查看项目详情
                layer.open({
                    type: 1,
                    title: '项目详情',
                    content: `
                            <div style="padding: 20px;">
                                <p><strong>项目ID:</strong> ${data.project_id}</p>
                                <p><strong>项目名称:</strong> ${data.project_name}</p>
                                <p><strong>项目来源:</strong> ${data.project_source}</p>
                                <p><strong>所属类别:</strong> ${data.category_name}</p>
                                <p><strong>立项金额:</strong> ￥${data.total_amount.toLocaleString()}</p>
                                <p><strong>余额:</strong> ￥${data.balance.toLocaleString()}</p>
                            </div>
                        `,
                    area: ['50%', '60%'],
                });
            } else if (event === 'delete') {
                // 删除项目
                layer.confirm('确定删除该项目吗？', function (index) {
                    // 发送删除请求到后端
                    fetch(`/admin/project/api/delete/${data.project_id}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => response.json())
                        .then(res => {
                            if (res.status === 'success') {
                                layer.msg('删除成功', { icon: 1 });
                                projectTable.reload();
                            } else {
                                layer.alert('删除失败: ' + res.message, { icon: 2 });
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            layer.alert('请求失败，请稍后再试。', { icon: 5 });
                        });
                    layer.close(index);
                });
            }
        });
    });
</script>
{% endblock %}