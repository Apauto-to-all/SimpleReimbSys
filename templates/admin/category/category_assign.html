{% extends 'base.html' %}

{% block title %}管理员 - 分配报销(项目)类别{% endblock %}

{% block content %}

<!-- 分配报销(项目)类别 -->
<h1>分配报销(项目)类别</h1>
<!-- 添加筛选框 -->
<form class="layui-form layui-row layui-col-space16">
    <div class="layui-col-md4">
        <div class="layui-input-wrap">
            <div class="layui-input-prefix">
                <i class="layui-icon layui-icon-search"></i>
            </div>
            <input type="text" name="category_name" value="" placeholder="输入需要筛选报销(项目)类别，支持模糊搜索" class="layui-input"
                lay-affix="clear">
        </div>
    </div>

    <!-- 分配状态筛选 -->
    <div class="layui-col-md4">
        <div class="layui-input-wrap">
            <div class="layui-input-prefix">
                <i class="layui-icon layui-icon-auz"></i>
            </div>
            <select name="assign">
                <option value="-1">不限</option>
                <option value="0">未分配</option>
                <option value="1">已分配</option>
            </select>
        </div>
    </div>


    <div class="layui-btn-container layui-col-xs12">
        <button class="layui-btn" lay-submit lay-filter="searchCategory">筛选</button>
        <button type="reset" class="layui-btn layui-btn-primary" id="resetBtn">清除</button>
    </div>
</form>

<table class="layui-hide" id="categoryTable" lay-filter="categoryTable"></table>

<!-- 右侧操作栏 -->
<script type="text/html" id="assignTool">
    <a class="layui-btn layui-btn-xs" lay-event="add">分配财务人员</a>
    <a class="layui-btn layui-btn-xs" lay-event="manage">管理</a>
</script>

<script>
    layui.use(function () {
        var table = layui.table;
        var form = layui.form;
        var layer = layui.layer;

        // 初始化表格
        var categoryTable = table.render({
            elem: '#categoryTable',
            url: '/admin/category/api/search',
            method: 'GET',
            page: true,
            limits: [10, 20, 30, 50],
            limit: 10,
            cols: [[
                { field: 'category_id', title: 'ID', width: 80, sort: true },
                { field: 'category_name', title: '类别名称', width: 200 },
                {
                    field: 'finance_id_list', title: '财务人员', width: 200,
                    templet: function (d) {
                        return d.finance_id_list.length > 0
                            ? d.finance_id_list.join(', ')
                            : '<span style="color: red;">未分配财务人员</span>';
                    }
                },
                { fixed: 'right', title: '操作', templet: '#assignTool' }
            ]],
            toolbar: '#toolbarDemo', // 添加工具条
            title: '报销(项目)类别表',
        });

        // 筛选按钮
        form.on('submit(searchCategory)', function (data) {
            var field = data.field; // 获得表单字段
            // 执行筛选重载
            categoryTable.reload({
                where: {
                    category_name: field.category_name,
                    assign: field.assign
                },
                page: { curr: 1 } // 重置到第一页
            });
            return false; // 阻止默认 form 跳转
        });

        // 清除按钮点击事件
        document.getElementById('resetBtn').addEventListener('click', function () {
            // 重新加载表格，传递空的筛选参数
            categoryTable.reload({
                where: {
                    category_name: '',
                    assign: -1,
                },
                page: {
                    curr: 1 // 重新从第1页开始
                }
            });
        });

        // 监听表格中的工具事件
        table.on('tool(categoryTable)', function (obj) {
            var data = obj.data; // 当前行数据
            var event = obj.event; // 事件类型

            if (event === 'add') {
                // 分配财务人员,添加人员

            } else if (event === 'manage') {
                // 管理人员.查看和删除人员

            }
        });
    });
</script>
{% endblock %}